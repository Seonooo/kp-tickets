# Testcontainers + Docker 기반 테스트 환경
# Docker 컨테이너 내에서 Gradle 실행 → Testcontainers가 MySQL, Redis, Kafka 자동 관리
# 사용법: docker-compose -f docker-compose.test.yml up --abort-on-container-exit

version: '3.8'

networks:
  test-network:
    driver: bridge

services:
  # 테스트 실행 컨테이너 (Gradle 8.5 + JDK 21)
  test-runner:
    image: gradle:8.5-jdk21
    container_name: concert-test-runner
    working_dir: /app

    # Docker-in-Docker를 위한 설정
    privileged: true

    volumes:
      # 프로젝트 소스 코드
      - .:/app
      # Gradle 캐시 (속도 향상)
      - gradle-test-cache:/home/gradle/.gradle
      # Docker socket 공유 (Testcontainers가 Host Docker 사용)
      - /var/run/docker.sock:/var/run/docker.sock

    networks:
      - test-network

    environment:
      # Gradle 캐시 위치
      GRADLE_USER_HOME: /home/gradle/.gradle

      # Testcontainers 설정
      TESTCONTAINERS_RYUK_DISABLED: "true"
      TESTCONTAINERS_CHECKS_DISABLE: "true"

      # Docker 네트워크 설정 (Testcontainers가 생성한 컨테이너 접근용)
      TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
      TESTCONTAINERS_HOST_OVERRIDE: host.docker.internal

      # Spring Profile
      SPRING_PROFILES_ACTIVE: test

    extra_hosts:
      - "host.docker.internal:host-gateway"

    command: >
      bash -c "
        echo '=========================================' &&
        echo '  Concert Ticketing Test Suite' &&
        echo '  Testcontainers + Docker 환경' &&
        echo '=========================================' &&
        echo '' &&
        echo '실행 환경:' &&
        echo '  - Gradle: 8.5' &&
        echo '  - JDK: 21' &&
        echo '  - OS: Linux (Docker Container)' &&
        echo '' &&
        echo 'Testcontainers가 자동으로 시작할 인프라:' &&
        echo '  - MySQL 8.0.36 (Core Service)' &&
        echo '  - Redis 7.2 (Queue Service)' &&
        echo '  - Redis 7.2 (Core Service)' &&
        echo '  - Kafka 7.6.1 (공통)' &&
        echo '' &&
        echo '=========================================' &&
        echo '' &&
        echo '[1/3] Gradle 의존성 확인 중...' &&
        ./gradlew dependencies --no-daemon --quiet || true &&
        echo '' &&
        echo '[2/3] 프로젝트 빌드 중...' &&
        ./gradlew clean compileTestJava --no-daemon &&
        echo '' &&
        echo '[3/3] 테스트 실행 중...' &&
        echo '(Testcontainers가 필요한 컨테이너를 자동으로 시작합니다)' &&
        echo '' &&
        ./gradlew test --no-daemon --stacktrace &&
        EXIT_CODE=\$$? &&
        echo '' &&
        echo '=========================================' &&
        if [ \$$EXIT_CODE -eq 0 ]; then
          echo '  ✅ 모든 테스트 성공!' &&
          echo '=========================================' &&
          echo '' &&
          echo '테스트 리포트:' &&
          echo '  - Core Service:' &&
          echo '    HTML: ./core-service/build/reports/tests/test/index.html' &&
          echo '    Cucumber: ./core-service/build/reports/cucumber/' &&
          echo '  - Queue Service:' &&
          echo '    HTML: ./queue-service/build/reports/tests/test/index.html' &&
          echo '    Cucumber: ./queue-service/build/reports/cucumber/' &&
          echo '';
        else
          echo '  ❌ 테스트 실패 (Exit Code: '\$$EXIT_CODE')' &&
          echo '=========================================' &&
          echo '' &&
          echo '실패 원인 확인:' &&
          echo '  1. 테스트 리포트 확인:' &&
          echo '     ./core-service/build/reports/tests/test/index.html' &&
          echo '     ./queue-service/build/reports/tests/test/index.html' &&
          echo '' &&
          echo '  2. 로그 확인:' &&
          echo '     docker-compose -f docker-compose.test.yml logs test-runner' &&
          echo '';
        fi &&
        exit \$$EXIT_CODE
      "

volumes:
  gradle-test-cache:
    driver: local
